#!/bin/sh

# chmod +x /etc/init.d/S99wifi

WIFACE="wlan0"
WPA_CONF="/etc/wpa_supplicant.conf"
PIDFILE="/var/run/wpa_supplicant.${WIFACE}.pid"
LOGFILE="/tmp/wpa_supplicant.${WIFACE}.log"

# Static network settings
STATIC_IP="192.168.1.221/24"
GATEWAY="192.168.1.1"
DNS="192.168.1.1"

wait_ready() {
    # Wait up to 30s for interface to exist
    i=0
    while [ $i -lt 30 ]; do
        ip link show "${WIFACE}" >/dev/null 2>&1 && break
        sleep 1
        i=$((i+1))
    done
    ip link show "${WIFACE}" >/dev/null 2>&1 || return 1

    # Wait up to 30s for driver/firmware to be usable
    j=0
    while [ $j -lt 30 ]; do
        ip link set "${WIFACE}" up >/dev/null 2>&1 || true

        # Some builds have /sys/class/net/wlan0/phy80211, others don't.
        if [ -d "/sys/class/net/${WIFACE}/phy80211" ]; then
            return 0
        fi
        if [ -e "/sys/class/net/${WIFACE}/address" ] && [ -e "/sys/class/net/${WIFACE}/operstate" ]; then
            return 0
        fi

        sleep 1
        j=$((j+1))
    done
    return 0
}

start() {
    echo "[wifi] waiting for ${WIFACE} readiness..."
    if ! wait_ready; then
        echo "[wifi] ${WIFACE} not ready; abort"
        return 1
    fi

    echo "[wifi] bringing up ${WIFACE}"
    ip link set "${WIFACE}" up

    echo "[wifi] starting wpa_supplicant"
    killall wpa_supplicant 2>/dev/null || true
    rm -f "${PIDFILE}"
    wpa_supplicant -B -i "${WIFACE}" -c "${WPA_CONF}" -D nl80211 -P "${PIDFILE}" -f "${LOGFILE}"

    echo "[wifi] configuring static IP ${STATIC_IP}"
    ip addr flush dev "${WIFACE}"
    ip addr add "${STATIC_IP}" dev "${WIFACE}"

    echo "[wifi] setting default route via ${GATEWAY}"
    ip route del default 2>/dev/null || true
    ip route add default via "${GATEWAY}" dev "${WIFACE}"

    echo "[wifi] setting DNS ${DNS}"
    echo "nameserver ${DNS}" > /etc/resolv.conf
}

stop() {
    echo "[wifi] stopping"
    [ -f "${PIDFILE}" ] && kill "$(cat "${PIDFILE}" 2>/dev/null)" 2>/dev/null || true
    rm -f "${PIDFILE}"
    ip link set "${WIFACE}" down 2>/dev/null || true
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) stop; start ;;
    *) echo "Usage: $0 {start|stop|restart}"; exit 1 ;;
esac

exit 0
