#!/bin/sh

NAME="majestic-manager"
DAEMON="/root/majestic_manager"
LOG="/root/majestic_manager.log"
TTY="/dev/ttyS2"
PID="/var/run/${NAME}.pid"

start() {
  # predictable environment
  export PATH=/usr/sbin:/usr/bin:/sbin:/bin
  cd / || exit 1

  echo "----- $(date) [init] start $NAME -----" >> "$LOG"

  # wait for UART device node
  i=0
  while [ ! -e "$TTY" ] && [ $i -lt 50 ]; do
    echo "$(date) [init] waiting for $TTY ($i)" >> "$LOG"
    i=$((i+1))
    sleep 0.2
  done

  if [ ! -e "$TTY" ]; then
    echo "$(date) [init] ERROR: $TTY not found" >> "$LOG"
    return 1
  fi

  # set UART explicitly (MAVLink common: 57600, 8N1, no flow control)
  stty -F "$TTY" 57600 cs8 -cstopb -parenb -ixon -ixoff -crtscts 2>>"$LOG"
  stty -F "$TTY" -a >> "$LOG" 2>&1

  # optional: wait a bit for other init scripts / matek stream to stabilize
  sleep 1

  # start daemon
  "$DAEMON" >>"$LOG" 2>&1 &
  echo $! > "$PID"
  echo "$(date) [init] started $NAME pid=$(cat "$PID")" >> "$LOG"
}

stop() {
  echo "----- $(date) [init] stop $NAME -----" >> "$LOG"

  if [ -f "$PID" ]; then
    kill "$(cat "$PID")" 2>>"$LOG"
    rm -f "$PID"
  else
    # fallback if pidfile missing
    killall majestic_manager 2>>"$LOG"
  fi
}

case "$1" in
  start) start ;;
  stop) stop ;;
  restart) stop; sleep 1; start ;;
  *) echo "Usage: $0 {start|stop|restart}" ;;
esac

exit 0
